<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>あーちゃんのお店</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            position: relative;
        }

        .header {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
            padding: 20px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .title {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .language-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            justify-content: center;
            margin-top: 15px;
        }

        .lang-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }

        .lang-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .lang-btn.active {
            background: white;
            color: #ff6b6b;
        }

        .menu-container {
            position: relative;
            height: calc(100vh - 140px);
            overflow: hidden;
        }

        .menu-wrapper {
            display: flex;
            height: 100%;
            transition: transform 0.3s ease;
            will-change: transform;
        }

        .menu-item {
            min-width: 100%;
            padding: 30px 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            position: relative;
        }

        .menu-image {
            width: 280px;
            height: 280px;
            object-fit: cover;
            border-radius: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            transition: transform 0.3s ease;
        }

        .menu-image:hover {
            transform: scale(1.02);
        }

        .menu-name {
            font-size: 1.8rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
        }

        .menu-price {
            font-size: 1.4rem;
            color: #ff6b6b;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .local-price {
            font-size: 1rem;
            color: #666;
            margin-top: 5px;
        }

        .menu-description {
            font-size: 1rem;
            color: #666;
            line-height: 1.6;
            max-width: 90%;
        }

        .navigation {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
        }

        .nav-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: rgba(0,0,0,0.3);
            cursor: pointer;
            transition: background 0.3s;
        }

        .nav-dot.active {
            background: #ff6b6b;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            font-size: 1.2rem;
            color: #666;
        }

        .error {
            text-align: center;
            color: #ff4757;
            padding: 20px;
        }

        /* タッチ対応のためのスタイル */
        .menu-container {
            touch-action: pan-y;
            -webkit-overflow-scrolling: touch;
        }

        @media (max-width: 480px) {
            .menu-image {
                width: 240px;
                height: 240px;
            }
            
            .menu-name {
                font-size: 1.5rem;
            }
            
            .lang-btn {
                font-size: 0.7rem;
                padding: 4px 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">あーちゃんのお店</h1>
            <div class="language-buttons">
                <button class="lang-btn active" data-lang="ja">日本語</button>
                <button class="lang-btn" data-lang="en">English</button>
                <button class="lang-btn" data-lang="ko">한국어</button>
                <button class="lang-btn" data-lang="zh">中文(简)</button>
                <button class="lang-btn" data-lang="zh-TW">中文(繁)</button>
                <button class="lang-btn" data-lang="es">Español</button>
                <button class="lang-btn" data-lang="fr">Français</button>
                <button class="lang-btn" data-lang="de">Deutsch</button>
                <button class="lang-btn" data-lang="it">Italiano</button>
                <button class="lang-btn" data-lang="pt">Português</button>
                <button class="lang-btn" data-lang="ru">Русский</button>
                <button class="lang-btn" data-lang="ar">العربية</button>
                <button class="lang-btn" data-lang="th">ไทย</button>
                <button class="lang-btn" data-lang="vi">Tiếng Việt</button>
                <button class="lang-btn" data-lang="hi">हिंदी</button>
                <button class="lang-btn" data-lang="id">Bahasa Indonesia</button>
                <button class="lang-btn" data-lang="ms">Bahasa Melayu</button>
                <button class="lang-btn" data-lang="tl">Filipino</button>
                <button class="lang-btn" data-lang="nl">Nederlands</button>
                <button class="lang-btn" data-lang="sv">Svenska</button>
            </div>
        </div>

        <div class="menu-container">
            <div class="loading" id="loading">メニューを読み込み中...</div>
            <div class="menu-wrapper" id="menuWrapper" style="display: none;"></div>
            <div class="navigation" id="navigation" style="display: none;"></div>
        </div>
    </div>

    <script>
        class MenuApp {
            constructor() {
                // APIエンドポイントを使用（環境変数はサーバーサイドで処理）
                this.apiEndpoint = '/api';
                this.menuData = [];
                this.translatedData = {};
                this.currentLang = 'ja';
                this.currentIndex = 0;
                this.touchStartX = 0;
                this.touchEndX = 0;
                
                // 通貨マッピング
                this.currencyMap = {
                    ja: { code: 'JPY', rate: 1, symbol: '¥' },
                    en: { code: 'USD', rate: 0.0067, symbol: '$' },
                    ko: { code: 'KRW', rate: 8.9, symbol: '₩' },
                    zh: { code: 'CNY', rate: 0.048, symbol: '¥' },
                    'zh-TW': { code: 'TWD', rate: 0.21, symbol: 'NT$' },
                    es: { code: 'EUR', rate: 0.0062, symbol: '€' },
                    fr: { code: 'EUR', rate: 0.0062, symbol: '€' },
                    de: { code: 'EUR', rate: 0.0062, symbol: '€' },
                    it: { code: 'EUR', rate: 0.0062, symbol: '€' },
                    pt: { code: 'EUR', rate: 0.0062, symbol: '€' },
                    ru: { code: 'RUB', rate: 0.62, symbol: '₽' },
                    ar: { code: 'AED', rate: 0.025, symbol: 'د.إ' },
                    th: { code: 'THB', rate: 0.23, symbol: '฿' },
                    vi: { code: 'VND', rate: 165, symbol: '₫' },
                    hi: { code: 'INR', rate: 0.56, symbol: '₹' },
                    id: { code: 'IDR', rate: 103, symbol: 'Rp' },
                    ms: { code: 'MYR', rate: 0.031, symbol: 'RM' },
                    tl: { code: 'PHP', rate: 0.38, symbol: '₱' },
                    nl: { code: 'EUR', rate: 0.0062, symbol: '€' },
                    sv: { code: 'SEK', rate: 0.072, symbol: 'kr' }
                };

                this.init();
            }

            async init() {
                try {
                    await this.loadMenuData();
                    this.setupEventListeners();
                    this.renderMenu();
                } catch (error) {
                    this.showError('メニューデータの読み込みに失敗しました');
                }
            }

            parsePrice(priceValue) {
                if (!priceValue) return 0;
                
                // 文字列の場合、数字以外を除去して数値に変換
                if (typeof priceValue === 'string') {
                    // 通貨記号、カンマ、スペースを除去して数字のみを抽出
                    const numericValue = priceValue.replace(/[^\d.-]/g, '');
                    return parseInt(numericValue) || 0;
                }
                
                // 既に数値の場合はそのまま使用
                if (typeof priceValue === 'number') {
                    return Math.round(priceValue);
                }
                
                return 0;
            }

            async loadMenuData() {
                try {
                    const response = await fetch(`${this.apiEndpoint}/menu`);
                    const data = await response.json();
                    
                    if (data.success && data.menuData) {
                        this.menuData = data.menuData;
                    } else {
                        throw new Error(data.error || 'メニューデータが見つかりません');
                    }
                } catch (error) {
                    console.error('Menu loading error:', error);
                    throw error;
                }
            }

            async translateText(text, targetLang) {
                if (targetLang === 'ja') return text;
                
                const cacheKey = `${text}_${targetLang}`;
                if (this.translatedData[cacheKey]) {
                    return this.translatedData[cacheKey];
                }

                try {
                    const response = await fetch(`${this.apiEndpoint}/translate`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            text: text,
                            targetLang: targetLang
                        })
                    });

                    const data = await response.json();
                    if (data.success && data.translatedText) {
                        this.translatedData[cacheKey] = data.translatedText;
                        return data.translatedText;
                    }
                } catch (error) {
                    console.error('Translation error:', error);
                }
                
                return text;
            }

            formatPrice(price, lang) {
                const currency = this.currencyMap[lang];
                if (!currency) return `¥${price}`;

                const convertedPrice = Math.round(price * currency.rate);
                
                if (lang === 'ja') {
                    return `${currency.symbol}${price.toLocaleString()}`;
                } else {
                    return `${currency.symbol}${convertedPrice.toLocaleString()}`;
                }
            }

            async renderMenu() {
                const loading = document.getElementById('loading');
                const menuWrapper = document.getElementById('menuWrapper');
                const navigation = document.getElementById('navigation');

                loading.style.display = 'flex';
                menuWrapper.style.display = 'none';
                navigation.style.display = 'none';

                try {
                    menuWrapper.innerHTML = '';
                    navigation.innerHTML = '';

                    for (let i = 0; i < this.menuData.length; i++) {
                        const item = this.menuData[i];
                        const translatedName = await this.translateText(item.name, this.currentLang);
                        const translatedDescription = await this.translateText(item.description, this.currentLang);

                        const menuItem = document.createElement('div');
                        menuItem.className = 'menu-item';
                        
                        const localPrice = this.currentLang !== 'ja' 
                            ? `<div class="local-price">(${this.formatPrice(item.price, this.currentLang)})</div>`
                            : '';

                        menuItem.innerHTML = `
                            <h2 class="menu-name">${translatedName}</h2>
                            <img class="menu-image" src="${item.imageNumber}.jpg" alt="${translatedName}" onerror="this.src='placeholder.jpg'">
                            <div class="menu-price">
                                ¥${item.price.toLocaleString()}
                                ${localPrice}
                            </div>
                            <p class="menu-description">${translatedDescription}</p>
                        `;
                        menuWrapper.appendChild(menuItem);

                        // ナビゲーションドット
                        const dot = document.createElement('div');
                        dot.className = `nav-dot ${i === 0 ? 'active' : ''}`;
                        dot.addEventListener('click', () => this.goToSlide(i));
                        navigation.appendChild(dot);
                    }

                    loading.style.display = 'none';
                    menuWrapper.style.display = 'flex';
                    navigation.style.display = 'flex';

                    this.updateSlide();

                } catch (error) {
                    this.showError('メニューの表示に失敗しました');
                }
            }

            setupEventListeners() {
                // 言語ボタン
                document.querySelectorAll('.lang-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        document.querySelector('.lang-btn.active').classList.remove('active');
                        e.target.classList.add('active');
                        this.currentLang = e.target.dataset.lang;
                        await this.renderMenu();
                    });
                });

                // タッチイベント
                const menuContainer = document.querySelector('.menu-container');
                menuContainer.addEventListener('touchstart', (e) => {
                    this.touchStartX = e.touches[0].clientX;
                });

                menuContainer.addEventListener('touchend', (e) => {
                    this.touchEndX = e.changedTouches[0].clientX;
                    this.handleSwipe();
                });

                // キーボードイベント
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'ArrowLeft') this.prevSlide();
                    if (e.key === 'ArrowRight') this.nextSlide();
                });
            }

            handleSwipe() {
                const threshold = 50;
                const diff = this.touchStartX - this.touchEndX;

                if (Math.abs(diff) > threshold) {
                    if (diff > 0) {
                        this.nextSlide();
                    } else {
                        this.prevSlide();
                    }
                }
            }

            nextSlide() {
                if (this.currentIndex < this.menuData.length - 1) {
                    this.currentIndex++;
                    this.updateSlide();
                }
            }

            prevSlide() {
                if (this.currentIndex > 0) {
                    this.currentIndex--;
                    this.updateSlide();
                }
            }

            goToSlide(index) {
                this.currentIndex = index;
                this.updateSlide();
            }

            updateSlide() {
                const menuWrapper = document.getElementById('menuWrapper');
                const dots = document.querySelectorAll('.nav-dot');
                
                menuWrapper.style.transform = `translateX(-${this.currentIndex * 100}%)`;
                
                dots.forEach((dot, index) => {
                    dot.classList.toggle('active', index === this.currentIndex);
                });
            }

            showError(message) {
                const loading = document.getElementById('loading');
                loading.innerHTML = `<div class="error">${message}</div>`;
            }
        }

        // アプリケーション起動
        document.addEventListener('DOMContentLoaded', () => {
            new MenuApp();
        });
    </script>
</body>
</html>